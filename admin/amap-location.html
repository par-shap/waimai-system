<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>高德地图POI搜索与定位</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="text/javascript">
    window._AMapSecurityConfig = {
      securityJsCode: '88131e5e8d6707e00b465f86aae89504'
    };
  </script>
  <script src="https://webapi.amap.com/maps?v=2.0&key=c424814a68db2d5a6f11750e81458a69"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { height: 100vh; width: 100vw; overflow: hidden; }
    #map { width: 100vw; height: 100vh; min-height: 100vh; position: relative; }
    .search-bar {
      position: absolute;
      top: 32px;
      left: 32px;
      z-index: 1001;
      display: flex;
      align-items: center;
      background: #f7f7fa;
      border-radius: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 0 16px;
      height: 48px;
      min-width: 340px;
      max-width: 90vw;
    }
    .search-bar .search-icon {
      width: 28px;
      height: 28px;
      margin-right: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .search-bar input {
      border: none;
      outline: none;
      font-size: 16px;
      flex: 1;
      min-width: 0;
      background: transparent;
      padding: 0 8px;
      color: #333;
      height: 40px;
    }
    .search-bar .search-btn {
      background: none;
      border: none;
      outline: none;
      cursor: pointer;
      margin-left: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      box-shadow: none;
      filter: none;
    }
    .search-bar .search-btn svg {
      width: 24px;
      height: 24px;
      color: #888;
      box-shadow: none;
      filter: none;
      stroke: none;
      outline: none;
      background: none;
      display: block;
    }
    #searchResult {
      position: absolute;
      top: 80px;
      left: 32px;
      background: #fff;
      border: 1px solid #ccc;
      width: 340px;
      max-width: 90vw;
      max-height: 260px;
      overflow-y: auto;
      z-index: 1002;
      list-style: none;
      margin: 0;
      padding: 0;
      border-radius: 0 0 16px 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    #searchResult li { padding: 10px 22px; cursor: pointer; transition: background 0.2s; white-space: nowrap; }
    #searchResult li:hover, #searchResult li.active { background: #f2f3f5; color: #1677ff; }
    #myLocationBtn { position: absolute; right: 30px; bottom: 30px; z-index: 1000; width: 48px; height: 48px; background: #fff; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .close-map-btn {
      padding: 8px 26px;
      border: none;
      border-radius: 18px;
      background: #ef4444;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      transition: background 0.18s, box-shadow 0.18s;
      margin-left: 18px;
      white-space: nowrap;
      /* 移除绝对定位相关属性 */
      position: static;
      left: auto;
      top: auto;
      z-index: auto;
    }
    .close-map-btn:hover {
      background: #b91c1c;
      box-shadow: 0 4px 16px #ef444455;
    }
    @media (max-width: 600px) {
      .search-bar {
        min-width: 0;
        max-width: 95vw;
        width: 350px;
        left: 2.5vw;
        right: 2.5vw;
        margin: 0 auto;
        padding: 0 4px;
      }
      .close-map-btn {
        padding: 7px 12px;
        font-size: 15px;
        margin-left: 6px;
      }
    }
  </style>
</head>
<body>
  <div id="map">
    <div class="search-bar">
      <span class="search-icon">
        <img src="https://webapi.amap.com/theme/v1.3/markers/n/loc.png" alt="定位" style="width:24px;height:24px;" />
      </span>
      <input type="text" id="searchInput" placeholder="搜索位置" autocomplete="off" />
      <button class="search-btn" id="searchBtn" tabindex="-1">
        <!-- 极简扁平放大镜图标 -->
        <svg style="pointer-events: none;" viewBox="0 0 24 24" width="24" height="24" fill="none"><circle cx="11" cy="11" r="7" stroke="#888" stroke-width="2"/><line x1="16.2" y1="16.2" x2="21" y2="21" stroke="#888" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <button id="closeMapBtn" class="close-map-btn" onclick="closeMap()">关闭</button>
    </div>
    <ul id="searchResult" style="display:none;"></ul>
    <!-- 我的位置小图标 -->
    <div id="myLocationBtn">
      <svg width="28" height="28" viewBox="0 0 1024 1024"><circle cx="512" cy="512" r="128" fill="#1677ff"/><circle cx="512" cy="512" r="64" fill="#fff"/><path d="M512 64v96m0 704v96m448-448h-96M160 512H64m751.36-287.36l-67.88 67.88M272.52 751.36l-67.88 67.88m0-607.12l67.88 67.88m607.12 0l-67.88 67.88" stroke="#1677ff" stroke-width="48" fill="none"/></svg>
    </div>
  </div>
  <div id="addressBar">请点击地图或搜索</div>
  <script>
    function closeMap() {
      if (window.opener) {
        window.close();
      } else {
        history.back();
      }
    }
    var map = new AMap.Map('map', {
      zoom: 13,
      center: [116.397428, 39.90923]
    });
    var marker = new AMap.Marker({ map: map });
    var infoWindow = null;
    var selectedAddress = '';

    // "我的位置"小图标点击事件
    document.getElementById('myLocationBtn').onclick = function() {
      locateMe();
    };
    function locateMe() {
      AMap.plugin('AMap.Geolocation', function() {
        var geolocation = new AMap.Geolocation({
          enableHighAccuracy: true,
          timeout: 10000
        });
        geolocation.getCurrentPosition(function(status, result) {
          if (status === 'complete' && result.position) {
            var lnglat = [result.position.lng, result.position.lat];
            map.setCenter(lnglat);
            marker.setPosition(lnglat);
            // 关闭旧信息窗
            if (infoWindow) infoWindow.close();
            infoWindow = new AMap.InfoWindow({
              content: '已定位到当前位置',
              offset: new AMap.Pixel(0, -30)
            });
            infoWindow.open(map, lnglat);
          } else {
            alert('定位失败，请检查浏览器权限或网络');
          }
        });
      });
    }

    // 严格按照高德官方教程加载插件和绑定事件
    AMap.plugin(['AMap.Geocoder', 'AMap.DistrictSearch', 'AMap.PlaceSearch'], function() {
      window.geocoder = new AMap.Geocoder();
      var placeSearch = new AMap.PlaceSearch({ map: map });
      window.infoWindow = new AMap.InfoWindow({ offset: new AMap.Pixel(0, -30) });

      // 输入联想功能
      AMap.plugin('AMap.Autocomplete', function() {
        var autoComplete = new AMap.Autocomplete({ input: 'searchInput' });
        var searchInput = document.getElementById('searchInput');
        var searchResult = document.getElementById('searchResult');
        var activeIndex = -1;
        var tips = [];

        searchInput.oninput = function () {
          var inputVal = this.value.trim();
          searchResult.innerHTML = '';
          activeIndex = -1;
          tips = [];
          if (!inputVal) { searchResult.style.display = 'none'; return; }
          autoComplete.search(inputVal, function (status, data) {
            if (status === 'complete' && data.tips.length) {
              searchResult.innerHTML = '';
              tips = data.tips.filter(function(item){ return item.name; });
              tips.forEach(function(item, idx) {
                var li = document.createElement('li');
                li.innerText = item.name + (item.district ? '（' + item.district + '）' : '');
                li.style.padding = '6px 12px';
                li.style.cursor = 'pointer';
                li.onmouseenter = function() {
                  setActive(idx);
                };
                li.onmouseleave = function() {
                  setActive(-1);
                };
                li.onclick = function () {
                  searchInput.value = item.name;
                  searchResult.style.display = 'none';
                  doPlaceSearch(item.name);
                };
                searchResult.appendChild(li);
              });
              searchResult.style.display = 'block';
            } else {
              searchResult.style.display = 'none';
            }
          });
        };

        // 键盘上下键选择
        searchInput.onkeydown = function(e) {
          if (searchResult.style.display === 'block' && tips.length) {
            if (e.key === 'ArrowDown') {
              activeIndex = (activeIndex + 1) % tips.length;
              setActive(activeIndex);
              e.preventDefault();
            } else if (e.key === 'ArrowUp') {
              activeIndex = (activeIndex - 1 + tips.length) % tips.length;
              setActive(activeIndex);
              e.preventDefault();
            } else if (e.key === 'Enter' && activeIndex >= 0) {
              searchInput.value = tips[activeIndex].name;
              searchResult.style.display = 'none';
              doPlaceSearch(tips[activeIndex].name);
              e.preventDefault();
            }
          }
        };

        // 失焦隐藏
        searchInput.onblur = function() { setTimeout(function(){ searchResult.style.display = 'none'; }, 200); };

        function setActive(idx) {
          Array.from(searchResult.children).forEach(function(li, i) {
            li.style.background = (i === idx) ? '#e6f7ff' : '';
          });
          activeIndex = idx;
        }
      });

      // 搜索按钮
      document.getElementById('searchBtn').onclick = function() {
        var keyword = document.getElementById('searchInput').value.trim();
        if (!keyword) return;
        // 先查行政区划
        var district = new AMap.DistrictSearch({
          subdistrict: 0,
          extensions: 'all',
          level: 'district'
        });
        district.search(keyword, function(status, result) {
          if (status === 'complete' && result.districtList && result.districtList.length && result.districtList[0].boundaries) {
            // 清除旧polygon
            if (window._districtPolygons) {
              window._districtPolygons.forEach(function(p) { map.remove(p); });
            }
            window._districtPolygons = [];
            var bounds = result.districtList[0].boundaries;
            for (var i = 0; i < bounds.length; i++) {
              var polygon = new AMap.Polygon({
                map: map,
                path: bounds[i],
                strokeColor: '#FF33FF',
                strokeWeight: 2,
                fillColor: '#1791fc',
                fillOpacity: 0.1
              });
              window._districtPolygons.push(polygon);
            }
            map.setFitView(window._districtPolygons);
            document.getElementById('addressBar').textContent = '已为您高亮显示 "' + keyword + '" 的行政区划';
          } else {
            // 没有边界再走POI搜索
            doPlaceSearch(keyword);
          }
        });
      };

      // 逆地理编码：点击地图获取地址
      map.on('click', function(e) {
        marker.setPosition(e.lnglat);
        geocoder.getAddress(e.lnglat, function(status, result) {
          if (status === 'complete' && result.regeocode) {
            var addr = result.regeocode.formattedAddress;
            document.getElementById('addressBar').textContent = '点击位置地址：' + addr;
            // 弹窗内容加确认按钮
            var infoHtml = '<div style="font-size:15px;max-width:220px;line-height:1.5;">' +
              addr + '<br>' +
              '<button id="confirmAddrBtn" data-address="' + (addr || '') + '" style="margin-top:8px;padding:4px 16px;background:#1677ff;color:#fff;border:none;border-radius:4px;cursor:pointer;">确认</button>' +
              '</div>';
            infoWindow.setContent(infoHtml);
            infoWindow.open(map, e.lnglat);
            setTimeout(function() {
              var btn = document.getElementById('confirmAddrBtn');
              if (btn) {
                btn.onclick = function() {
                  var addr = btn.getAttribute('data-address');
                  if(addr) {
                    document.getElementById('addressBar').textContent = addr;
                    // 通知父页面自动填写表单
                    if (window.opener) {
                      window.opener.postMessage({ type: 'amap-location', address: addr }, '*');
                    } else if (window.parent && window.parent !== window) {
                      window.parent.postMessage({ type: 'amap-location', address: addr }, '*');
                    }
                  }
                  infoWindow.close();
                };
              }
            }, 300);
          } else {
            document.getElementById('addressBar').textContent = '无法获取该点地址';
          }
        });
      });

      // 定位到当前位置并搜索附近餐馆
      document.getElementById('locateBtn').onclick = function() {
        AMap.plugin('AMap.Geolocation', function() {
          var geolocation = new AMap.Geolocation({
            enableHighAccuracy: true,
            timeout: 10000
          });
          geolocation.getCurrentPosition(function(status, result) {
            if (status === 'complete') {
              var lnglat = [result.position.lng, result.position.lat];
              map.setCenter(lnglat);
              marker.setPosition(lnglat);
              document.getElementById('addressBar').textContent = '已定位到当前位置，正在搜索附近餐馆...';
              placeSearch.searchNearBy('餐馆', lnglat, 1000, function(status, result) {
                if (status === 'complete' && result.info === 'OK') {
                  document.getElementById('addressBar').textContent = '已为您搜索当前位置附近餐馆';
                } else {
                  document.getElementById('addressBar').textContent = '附近未找到餐馆';
                }
              });
            } else {
              document.getElementById('addressBar').textContent = '定位失败，请检查浏览器权限';
            }
          });
        });
      };
    });

    // 地点搜索（只显示第一个POI定位点）
    function doPlaceSearch(keyword) {
      AMap.plugin('AMap.PlaceSearch', function() {
        var placeSearch = new AMap.PlaceSearch({
          pageSize: 10,
          pageIndex: 1,
          city: '全国',
          map: null // 不自动渲染到地图
        });
        placeSearch.search(keyword, function(status, result) {
          if (status === 'complete' && result.poiList && result.poiList.pois.length) {
            var firstPoi = result.poiList.pois[0];
            if (firstPoi && firstPoi.location) {
              map.setCenter(firstPoi.location);
              marker.setPosition(firstPoi.location);
              // 逆地理编码获取详细地址，暂存
              if (window.geocoder) {
                window.geocoder.getAddress(firstPoi.location, function(status, result) {
                  var addr = '';
                  if (status === 'complete' && result.regeocode) {
                    addr = result.regeocode.formattedAddress;
                    selectedAddress = addr;
                  } else {
                    addr = '';
                    selectedAddress = '';
                  }
                  // 弹出带确定按钮的InfoWindow，地址写入data属性
                  var infoHtml = '<div style="font-size:15px;max-width:220px;line-height:1.5;">' +
                    (firstPoi.name ? '<b>' + firstPoi.name + '</b><br>' : '') +
                    (addr ? addr + '<br>' : '') +
                    '<button id="confirmAddrBtn" data-address="' + (addr || '') + '" style="margin-top:8px;padding:4px 16px;background:#1677ff;color:#fff;border:none;border-radius:4px;cursor:pointer;">确定</button>' +
                    '</div>';
                  if (window.infoWindow) window.infoWindow.close();
                  window.infoWindow = new AMap.InfoWindow({
                    content: infoHtml,
                    offset: new AMap.Pixel(0, -30)
                  });
                  window.infoWindow.open(map, firstPoi.location);
                  // 绑定"确定"按钮事件，直接读取data-address
                  setTimeout(function() {
                    var btn = document.getElementById('confirmAddrBtn');
                    if (btn) {
                      btn.onclick = function() {
                        var addr = btn.getAttribute('data-address');
                        if(addr) {
                          document.getElementById('addressBar').textContent = addr;
                          // 通知父页面自动填写表单
                          if (window.opener) {
                            window.opener.postMessage({ type: 'amap-location', address: addr }, '*');
                          } else if (window.parent && window.parent !== window) {
                            window.parent.postMessage({ type: 'amap-location', address: addr }, '*');
                          }
                        }
                        window.infoWindow.close();
                      };
                    }
                  }, 300);
                });
              }
            }
          } else {
            alert('未找到相关地点');
          }
        });
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      var closeBtn = document.getElementById('closeMapBtn');
      if (closeBtn) {
        closeBtn.onclick = function() {
          if (window.opener) {
            window.close();
          } else {
            history.back();
          }
        };
      }
    });
  </script>
</body>
</html> 